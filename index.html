<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>L-EAF Assistant</title>
    <style>
        body {
            background-color: #ffffff;
            font-family: Arial, sans-serif;
            margin: 40px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input, textarea {
            width: 25%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        input[type="checkbox"] {
            margin-top: 0;
            width: auto;
        }

        input, textarea, select {
            font-family: 'Roboto', sans-serif; 
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
        }
        textarea {
            height: 100px;
            font-size: 16px; 
        }
        button {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #218838;
        }
        #output {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f9f9f9;
            max-height: 500px;
            overflow-y: scroll;
            width: 75%;
        }
        .message {
            margin-bottom: 20px;
        }
        .user-message, .assistant-message {
            padding: 10px;
            border-radius: 4px;
        }
        .user-message {
            background-color: #e7f4ff;
            border: 1px solid #a1c5e6;
        }
        .assistant-message {
            background-color: #fff3e7;
            border: 1px solid #e6c5a1;
        }
        hr {
            border: 0;
            height: 1px;
            background: #ccc;
            margin: 20px 0;
        }
        .section-title {
            font-weight: bold;
            margin-top: 10px;
        }
        .spinner {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #28a745;
            animation: spin 1s linear infinite;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transform-origin: center; 
        }

        @keyframes spin {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
            }
            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }
        #downloadPdfButton {
        margin-top: 20px; /* Space above the button */
        }
    </style>
</head>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">

<body>

    <h1>L-EAF Assistant</h1>
    <div class="form-group">
        <label for="subject">Subject</label>
        <input type="text" id="subject" name="subject" placeholder="Enter subject">
    </div>
    <div class="form-group">
        <label for="secondarySubject">Secondary Subject (Optional)</label>
        <input type="text" id="secondarySubject" name="secondarySubject">
    </div>
    <div class="form-group">
        <label for="grade">Grade Level</label>
        <select id="grade" name="grade">
            <option value="" disabled selected>Select a grade</option>
            <option value="1st">1st</option>
            <option value="2nd">2nd</option>
            <option value="3rd">3rd</option>
            <option value="4th">4th</option>
            <option value="5th">5th</option>
            <option value="6th">6th</option>
            <option value="7th">7th</option>
            <option value="8th">8th</option>
            <option value="9th">9th</option>
            <option value="10th">10th</option>
            <option value="11th">11th</option>
            <option value="12th">12th</option>
        </select>
        
    </div>

    <div class="form-group">
        <label for="state">State</label>
        
        <select id="state" name="state" style="margin-left: 10px; width: auto;">
            <option value="">N/A</option>
            <option value="AL">AL</option>
            <option value="AK">AK</option>
            <option value="AZ">AZ</option>
            <option value="AR">AR</option>
            <option value="CA">CA</option>
            <option value="CO">CO</option>
            <option value="CT">CT</option>
            <option value="DE">DE</option>
            <option value="FL">FL</option>
            <option value="GA">GA</option>
            <option value="HI">HI</option>
            <option value="ID">ID</option>
            <option value="IL">IL</option>
            <option value="IN">IN</option>
            <option value="IA">IA</option>
            <option value="KS">KS</option>
            <option value="KY">KY</option>
            <option value="LA">LA</option>
            <option value="ME">ME</option>
            <option value="MD">MD</option>
            <option value="MA">MA</option>
            <option value="MI">MI</option>
            <option value="MN">MN</option>
            <option value="MS">MS</option>
            <option value="MO">MO</option>
            <option value="MT">MT</option>
            <option value="NE">NE</option>
            <option value="NV">NV</option>
            <option value="NH">NH</option>
            <option value="NJ">NJ</option>
            <option value="NM">NM</option>
            <option value="NY">NY</option>
            <option value="NC">NC</option>
            <option value="ND">ND</option>
            <option value="OH">OH</option>
            <option value="OK">OK</option>
            <option value="OR">OR</option>
            <option value="PA">PA</option>
            <option value="RI">RI</option>
            <option value="SC">SC</option>
            <option value="SD">SD</option>
            <option value="TN">TN</option>
            <option value="TX">TX</option>
            <option value="UT">UT</option>
            <option value="VT">VT</option>
            <option value="VA">VA</option>
            <option value="WA">WA</option>
            <option value="WV">WV</option>
            <option value="WI">WI</option>
            <option value="WY">WY</option>
        </select>
    </div>

    <div class="form-group">
        <label for="standardBased">Standards Based</label>
        <input type="checkbox" id="standardBased" name="standardBased">
    </div>

    <div class="form-group">
        <label for="agileBased">Agile Based</label>
        <input type="checkbox" id="agileBased" name="agileBased" checked>
    </div>

    <div class="form-group">
        <label for="topics">Topics to Cover</label>
        <textarea id="topics" name="topics"></textarea>
    </div>

    <div class="form-group">
        <label for="unitPlan">Incude Unit Plan</label>
        <input type="checkbox" id="unitPlan" name="unitPlan" checked>
    </div>

    <div class="form-group">
        <label for="learningObjectives">Include Learning Objectives</label>
        <input type="checkbox" id="learningObjectives" name="learningObjectives" checked>
    </div>

    <div class="form-group">
        <label for="edit">Edit Request</label>
        <input type="text" id="edit" name="edit">
    </div>

    <button onclick="startConversation()">Submit</button>

    <div id="output"></div>

    <!-- Loading spinner -->
    <div class="spinner" id="spinner"></div>

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

    <button id="downloadPdfButton" onclick="downloadPDF(document.getElementById('output'))">Download Response as PDF</button>

    <button id="saveCsvButton" onclick="callAssistant('', false,true)">Download Response as CSV</button>


    <!-- Website code ends here -->


    <!-- API call code starts here -->

    <script>
        let conversationHistory = [];

        async function fetchFileContent(fileId, apiKey) {
            const response = await fetch(`https://api.openai.com/v1/files/${fileId}/content`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${apiKey}`
                }
            });

            if (!response.ok) {
                throw new Error(`File ${fileId} is not accessible. Status: ${response.status}`);
            }

            const content = await response.text();
            return content;
        }

        async function callAssistant(userMessage, editRequest, csvRequest=false) {
            try {
                // Show spinner
                document.getElementById('spinner').style.display = 'block';

                const apiKey = ''; // API key
                const combinedFileId = 'file-1NFmsYN5aiOdCvCFKJZpJjV6'; // file ID for info docs

                const fileContent = await fetchFileContent(combinedFileId, apiKey);
                if(csvRequest != true){
                    conversationHistory.push({ role: 'user', content: userMessage });
                }

                if (editRequest) {
                    console.log("edit request:");
                    //conversationHistory.push({ role: 'edit', content: editRequest }); // Push the edit request as part of the conversation
                    conversationHistory.push({ role: 'user', content: `Edit request: ${editRequest}` });
                }
                
                /*if (csvRequest) {
                    console.log("csv request:");
                    conversationHistory.push({ role: 'user', content: `Edit request: true` });
                    conversationHistory.push({ role: 'user', content: `Here is the set of new instructions. Please do just this and ignore previous instructions:` });
                    conversationHistory.push({ role: 'user', content: `The following is the format of a csv file: "Title    Description Planned End	Owner (email)	Label	Blocked Reason	Watchers	Card Container".Now using the learning plan you created earlier please give an example with a few cards and card descriptions.` });
                }*/

                console.log("Conversation History:", conversationHistory);

                if(csvRequest){
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            { role: 'system', content: `Instructions: The following is the format of a csv file: "Title    Description Planned End	Owner (email)	Label	Blocked Reason	Watchers	Card Container".
                            Now using the learning plan you created earlier please give an example with a few cards and card descriptions. Each card represents a sequential learning objective that would fit in based on the information provided in the last request, where the title summarizes
                            the objective and the description has helpful information for the teacher on what should guiding ideas for the unit. 
                            The card descriptions (in the csv format) should include Learning purpose, Learning value, a wide open question, Learning outcomes, Learning proofs, Milestones,and suggested resources.
                            Please include header and quotation marks around each example description. 
                            Please generate 3-6 cards.The example columns for Owner(email) watchers and card container can be left empty.` },
                            ...conversationHistory,
                            { role: 'assistant', content: fileContent }
                        ],
                        max_tokens: 1500
                        })
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();


                    if (data.choices && data.choices.length > 0) {
                        const assistantMessage = data.choices[0].message.content;
                        conversationHistory.push({ role: 'assistant', content: assistantMessage });
                        if(csvRequest){
                            generateCSV(assistantMessage);
                        }
                        //else{
                            const formattedMessage = formatOutput(assistantMessage);
                            const outputDiv = document.getElementById('output');
                            outputDiv.innerHTML += `
                                
                                <div class="message assistant-message"><strong>LEAF Assistant:</strong> ${formattedMessage}</div>
                                <hr>
                            `;
                            outputDiv.scrollTop = outputDiv.scrollHeight;
                        //}


                    } else {
                        throw new Error('No response from assistant');
                    }

                }
                else{
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [
                                { role: 'system', content: `Instructions:
    Purpose: The LearningFLOW AI Companion is a dynamic tool designed to assist educators in seamlessly translate learning standards, course descriptions and syllabi into the innovative LearningFLOW lesson plan format. 
    Key Deliverables: The AI Companion will generate five essential deliverable packages, each tailored to enhance the learning experience by incorporating Agile principles:
    1 . Sample Learning Objective Card with the following components:
    Wide Open Questions: Stimulate critical thinking and creativity.
    Learning Outcomes: Clearly defined goals for student achievement.
    Value of Learning Outcomes: Explanation of the practical and educational significance of each outcome.
    Learning Activities: Engaging tasks and exercises aligned with outcomes.
    Facilitating Questions: Guided queries to foster deeper understanding.
    Milestone Due Dates: Timelines for achieving key learning milestones.
    Resources: Curated educational materials and tools to support learning.
    Purpose: This card serves as a roadmap for each lesson, outlining the objectives and resources in a structured, easy-to-follow format.
    Student Team Guide:
    2. Practical tips and strategies to help student teams adopt and practice Agile methodologies.
    Purpose: To empower students with the skills and knowledge to work effectively in team settings.
    Class LearningBoard Creation Instructions:
    3. Step-by-step guidelines for creating a shared Class LearningBoard.
    Focus: Facilitate refining of Learning Objectives and Learning Goal cards collaboratively.
    Purpose: Enhance class engagement and participation in shaping the learning journey.
    Team LearningBoard Creation Instructions:
    4. Detailed instructions for teams to create their own LearningBoards.
    Focus: Guide teams in organizing and flowing Learning Task cards effectively.
    Purpose: Encourage team autonomy and efficient task management.
    Teacher LearningFLOW Cheat Sheet:
    5. Quick-reference guide for teachers, covering key LearningFLOW concepts and check-in strategies.
    Purpose: Provide educators with an at-a-glance tool to stay aligned with Agile practices and ensure smooth progress check-ins with teams.
    Utilizing the Companion:
    Incorporate these deliverables into your teaching practice to foster an environment of agile learning, collaboration, and continuous improvement. The LearningFLOW AI Companion is designed to streamline the educational process, making it more adaptive, engaging, and effective for both teachers and students.` },
                                ...conversationHistory,
                                { role: 'assistant', content: fileContent }
                            ],
                            max_tokens: 1500
                        })
                    });
                    if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();


                if (data.choices && data.choices.length > 0) {
                    const assistantMessage = data.choices[0].message.content;
                    conversationHistory.push({ role: 'assistant', content: assistantMessage });
                    if(csvRequest){
                        generateCSV(assistantMessage);
                    }
                    //else{
                        const formattedMessage = formatOutput(assistantMessage);
                        const outputDiv = document.getElementById('output');
                        outputDiv.innerHTML += `
                            
                            <div class="message assistant-message"><strong>LEAF Assistant:</strong> ${formattedMessage}</div>
                            <hr>
                        `;
                        outputDiv.scrollTop = outputDiv.scrollHeight;
                    //}


                } else {
                    throw new Error('No response from assistant');
                }
            }


            } catch (error) {
                console.error('Error:', error);
                document.getElementById('output').innerText = `Error: ${error.message}`;
            } finally {
                // Hide spinner
                document.getElementById('spinner').style.display = 'none';
            }
        }

        function startConversation() {
            const subject = document.getElementById('subject').value;
            const secondarySubject = document.getElementById('secondarySubject').value;
            const grade = document.getElementById('grade').value;
            const topics = document.getElementById('topics').value;
            const state = document.getElementById('state').value;
            const edit = document.getElementById('edit').value; // Get the edit request
            const isStandardBased = document.getElementById('standardBased').checked;
            const isAgileBased = document.getElementById('agileBased').checked;
            const isUnitPlan = document.getElementById('unitPlan').checked;
            const isLearningObjective = document.getElementById('learningObjectives').checked;

            let initialMessage = `Subject: ${subject}`;
            if (secondarySubject) {
                initialMessage += `\nSecondary Subject: ${secondarySubject}`;
            }
            initialMessage += `\nGrade Level: ${grade}\nTopics: ${topics}`;

            if (isStandardBased) {
                if(state !== "") {
                    initialMessage += `\nThis request is based on standard guidelines for state ${state}.`; // Append a note or modify as needed
                } else {
                    initialMessage += `\nThis request is based on standard guidelines.`;
                }
            }
            if (isAgileBased) {
                initialMessage += `\nThis approach is based on Agile methodologies.`;
            }
            else{
                initialMessage += `\nYou do not need to abide by Agile methodologies.`;
            }

            if (isUnitPlan) {
                initialMessage += `\nPlease include a unit plan in the response.`;
            }
            else{
                initialMessage += `\nA unit plan is not necessary.`;
            }
            if (isLearningObjective) {
                initialMessage += `\nPlease include a learning objectives in response.`;
            }
            else{
                initialMessage += `\nLearning objectives are not necessary.`;
            }
            callAssistant(initialMessage, edit);
        }

        function formatOutput(message) {
            const cleanMessage = message.replace(/[#*]/g, ''); // Remove pound signs and asterisks
            const sections = cleanMessage.split('\n').map(line => line.trim()).filter(line => line);
            let formattedMessage = '';

            sections.forEach((section) => {
                if (section.match(/^(Purpose|Wide Open Questions|Learning Outcomes|Value of Learning Outcomes|Learning Activities|Facilitating Questions|Milestone Due Dates|Resources|Student Team Guide|Practical tips|Class LearningBoard Creation Instructions|Team LearningBoard Creation Instructions|Teacher LearningFLOW Cheat Sheet|Utilizing the Companion):/)) {
                    formattedMessage += `<div class="section-title">${section}</div>`;
                } else {
                    formattedMessage += `<div>${section}</div>`;
                }
            });

            return formattedMessage;
        }

        function downloadPDF(htmlElement) {
            html2canvas(htmlElement).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                // Correctly access jsPDF from window.jspdf.jsPDF
                const pdf = new window.jspdf.jsPDF({
                    orientation: 'portrait',
                });

                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save('download.pdf');
            }).catch(error => {
                console.error('Error generating PDF:', error);
         });
    }

    function generateCSV(assistantMessage) {
        // Define the CSV header
        //const csvHeader = "Title,Description,Planned End,Owner (email),Label,Blocked Reason,Watchers,Card Container";

        // Normalize newline characters and split the input into rows
        const entries = assistantMessage.replace(/\r\n/g, "\n").split('\n').filter(line => line.trim() !== '');

        // Array to hold each row of the CSV
        let csvRows = [];

        // Process each entry except the first since it's the header
        entries.forEach(entry => {
            // Split the entry by comma carefully, considering that some fields may contain commas
            //let fields = entry.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); // Regex to correctly split by commas outside of quotes
            let fields = entry.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);

            // Trim spaces and ensure each field is correctly quoted
            fields = fields.map(field => {
                field = field.trim(); // Trim whitespace
                if (!field.startsWith('"')) { // Ensure fields are quoted if not already
                    field = `"${field.replace(/"/g, '""')}"`; // Escape quotes and wrap in quotes
                }
                return field;
            });

            // Join the fields back into a CSV row
            const csvRow = fields.join(',');
            csvRows.push(csvRow);
        });

        // Combine all rows into the full CSV content
        const csvContent = csvRows.join('\n');

        // URI encoding and download link creation
        const encodedUri = encodeURI(`data:text/csv;charset=utf-8,${csvContent}`);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "learning_cards.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }







    </script>
    <!-- API call code ends here -->

</body>
</html>
