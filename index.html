<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L-EAF Assistant</title>
    <style>
        body {
            background-color: #ffffff;
            font-family: Arial, sans-serif;
            margin: 40px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        input[type="checkbox"] {
            margin-top: 0;
            width: auto;
        }
        textarea {
            height: 100px;
            font-size: 16px;
        }
        button {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #218838;
        }
        #output {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f9f9f9;
            max-height: 500px;
            overflow-y: scroll;
            width: 75%;
        }
        .message {
            margin-bottom: 20px;
        }
        .user-message, .assistant-message {
            padding: 10px;
            border-radius: 4px;
        }
        .user-message {
            background-color: #e7f4ff;
            border: 1px solid #a1c5e6;
        }
        .assistant-message {
            background-color: #fff3e7;
            border: 1px solid #e6c5a1;
        }
        hr {
            border: 0;
            height: 1px;
            background: #ccc;
            margin: 20px 0;
        }
        .section-title {
            font-weight: bold;
            margin-top: 10px;
        }
        .spinner {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #28a745;
            animation: spin 1s linear infinite;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        @keyframes spin {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
            }
            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }
        #downloadPdfButton {
            margin-top: 20px;
        }
    </style>
</head>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">

<body>
    <h1>L-EAF Assistant</h1>

    <div class="form-group">
        <label for="subject">Subject</label>
        <input type="text" id="subject" name="subject" placeholder="Enter subject">
    </div>
    
    <div class="form-group">
        <label for="secondarySubject">Secondary Subject (Optional)</label>
        <input type="text" id="secondarySubject" name="secondarySubject">
    </div>

    <div class="form-group">
        <label for="grade">Grade Level</label>
        <select id="grade" name="grade">
            <option value="" disabled selected>Select a grade</option>
            <option value="1st">1st</option>
            <option value="2nd">2nd</option>
            <option value="3rd">3rd</option>
            <option value="4th">4th</option>
            <option value="5th">5th</option>
            <option value="6th">6th</option>
            <option value="7th">7th</option>
            <option value="8th">8th</option>
            <option value="9th">9th</option>
            <option value="10th">10th</option>
            <option value="11th">11th</option>
            <option value="12th">12th</option>
        </select>
    </div>

    <div class="form-group">
        <label for="state">State</label>
        <select id="state" name="state">
            <option value="">N/A</option>
            <option value="AL">AL</option>
            <option value="AK">AK</option>
            <option value="AZ">AZ</option>
            <option value="AR">AR</option>
            <option value="CA">CA</option>
            <option value="CO">CO</option>
            <option value="CT">CT</option>
            <option value="DE">DE</option>
            <option value="FL">FL</option>
            <option value="GA">GA</option>
            <option value="HI">HI</option>
            <option value="ID">ID</option>
            <option value="IL">IL</option>
            <option value="IN">IN</option>
            <option value="IA">IA</option>
            <option value="KS">KS</option>
            <option value="KY">KY</option>
            <option value="LA">LA</option>
            <option value="ME">ME</option>
            <option value="MD">MD</option>
            <option value="MA">MA</option>
            <option value="MI">MI</option>
            <option value="MN">MN</option>
            <option value="MS">MS</option>
            <option value="MO">MO</option>
            <option value="MT">MT</option>
            <option value="NE">NE</option>
            <option value="NV">NV</option>
            <option value="NH">NH</option>
            <option value="NJ">NJ</option>
            <option value="NM">NM</option>
            <option value="NY">NY</option>
            <option value="NC">NC</option>
            <option value="ND">ND</option>
            <option value="OH">OH</option>
            <option value="OK">OK</option>
            <option value="OR">OR</option>
            <option value="PA">PA</option>
            <option value="RI">RI</option>
            <option value="SC">SC</option>
            <option value="SD">SD</option>
            <option value="TN">TN</option>
            <option value="TX">TX</option>
            <option value="UT">UT</option>
            <option value="VT">VT</option>
            <option value="VA">VA</option>
            <option value="WA">WA</option>
            <option value="WV">WV</option>
            <option value="WI">WI</option>
            <option value="WY">WY</option>
        </select>
    </div>

    <div class="form-group">
        <label for="standardBased">Standards Based</label>
        <input type="checkbox" id="standardBased" name="standardBased">
    </div>

    <div class="form-group">
        <label for="agileBased">Agile Based</label>
        <input type="checkbox" id="agileBased" name="agileBased" checked>
    </div>

    <div class="form-group">
        <label for="topics">Topics to Cover</label>
        <textarea id="topics" name="topics"></textarea>
    </div>

    <div class="form-group">
        <label for="unitPlan">Include Unit Plan</label>
        <input type="checkbox" id="unitPlan" name="unitPlan" checked>
    </div>

    <div class="form-group">
        <label for="learningObjectives">Include Learning Objectives</label>
        <input type="checkbox" id="learningObjectives" name="learningObjectives" checked>
    </div>

    <div class="form-group">
        <label for="edit">Edit Request</label>
        <input type="text" id="edit" name="edit">
    </div>

    <button onclick="startConversation()">Submit</button>

    <div id="output"></div>

    <!-- Loading spinner -->
    <div class="spinner" id="spinner"></div>

    <button id="downloadPdfButton" onclick="downloadPDF(document.getElementById('output'))">Download Response as PDF</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

    <script>
        let conversationHistory = [];

        // Replace the API URL with your API Gateway URL
        const apiGatewayUrl = 'https://x1ltk8tvia.execute-api.us-east-1.amazonaws.com/prod/generate'; // Add your API Gateway URL here

        async function callAssistant(userMessage, editRequest) {
            try {
                document.getElementById('spinner').style.display = 'block';

                conversationHistory.push({ role: 'user', content: userMessage });

                if (editRequest) {
                    conversationHistory.push({ role: 'user', content: `Edit request: ${editRequest}` });
                }

                const response = await fetch(apiGatewayUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userMessage: userMessage,
                        editRequest: editRequest || ''
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.message) {
                    const assistantMessage = data.message;
                    conversationHistory.push({ role: 'assistant', content: assistantMessage });

                    const formattedMessage = formatOutput(assistantMessage);
                    const outputDiv = document.getElementById('output');
                    outputDiv.innerHTML += `<div class="message assistant-message"><strong>LEAF Assistant:</strong> ${formattedMessage}</div><hr>`;
                    outputDiv.scrollTop = outputDiv.scrollHeight;
                } else {
                    throw new Error('No response from assistant');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('output').innerText = `Error: ${error.message}`;
            } finally {
                document.getElementById('spinner').style.display = 'none';
            }
        }

        function startConversation() {
            const subject = document.getElementById('subject').value;
            const secondarySubject = document.getElementById('secondarySubject').value;
            const grade = document.getElementById('grade').value;
            const topics = document.getElementById('topics').value;
            const state = document.getElementById('state').value;
            const edit = document.getElementById('edit').value;
            const isStandardBased = document.getElementById('standardBased').checked;
            const isAgileBased = document.getElementById('agileBased').checked;
            const isUnitPlan = document.getElementById('unitPlan').checked;
            const isLearningObjective = document.getElementById('learningObjectives').checked;

            let initialMessage = `Subject: ${subject}`;
            if (secondarySubject) {
                initialMessage += `\nSecondary Subject: ${secondarySubject}`;
            }
            initialMessage += `\nGrade Level: ${grade}\nTopics: ${topics}`;

            if (isStandardBased) {
                initialMessage += `\nThis request is based on standard guidelines for state ${state}.`;
            }
            if (isAgileBased) {
                initialMessage += `\nThis approach is based on Agile methodologies.`;
            }
            if (isUnitPlan) {
                initialMessage += `\nPlease include a unit plan in the response.`;
            }
            if (isLearningObjective) {
                initialMessage += `\nPlease include learning objectives in the response.`;
            }

            callAssistant(initialMessage, edit);
        }

        function formatOutput(message) {
            const cleanMessage = message.replace(/[#*]/g, ''); // Remove pound signs and asterisks
            const sections = cleanMessage.split('\n').map(line => line.trim()).filter(line => line);
            let formattedMessage = '';

            sections.forEach((section) => {
                if (section.match(/^(Purpose|Wide Open Questions|Learning Outcomes|Value of Learning Outcomes|Learning Activities|Facilitating Questions|Milestone Due Dates|Resources|Student Team Guide|Practical tips):/)) {
                    formattedMessage += `<div class="section-title">${section}</div>`;
                } else {
                    formattedMessage += `<div>${section}</div>`;
                }
            });

            return formattedMessage;
        }

        function downloadPDF(htmlElement) {
            html2canvas(htmlElement).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new window.jspdf.jsPDF({
                    orientation: 'portrait',
                });

                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save('download.pdf');
            }).catch(error => {
                console.error('Error generating PDF:', error);
            });
        }
    </script>
</body>
</html>
